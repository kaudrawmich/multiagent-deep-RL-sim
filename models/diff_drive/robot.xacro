<?xml version="1.0"?>
<robot name="diff_drive" xmlns:xacro="http://www.ros.org/wiki/xacro">

<!-- ================================ CONSTANTS =============================== -->
<xacro:property name="pi_const" value="3.14159265"/>

<!-- ================================= BODY =================================== -->
<xacro:property name="a" value="0.55"  /> <!-- L (m) -->
<xacro:property name="b" value="0.12" /> <!-- W (m) -->
<xacro:property name="c" value="0.30"/> <!-- H (m) -->

<!-- ================================= WHEELS ================================= -->
<xacro:property name="r" value="0.08" /> <!-- R (m) -->
<xacro:property name="d" value="0.03"/> <!-- W (m) -->

<!-- ============================= Body constants ============================= -->
<xacro:property name="s1" value="${b/2+r}"/>
<xacro:property name="s2" value="${2*r}"/>
<xacro:property name="s3" value="${2*r}"/>
<xacro:property name="s4" value="${c/2+d/2}"/>

<!-- ============================== MATERIAL DENSITY ========================== -->
<xacro:property name="d1" value="381.0"/> <!-- Body -->
<xacro:property name="d2" value="500.0"/> <!-- Wheels -->
<xacro:property name="d3" value="100.0"/> <!-- Caster -->

<!-- ================================== MASS ================================== -->
<xacro:property name="m1" value="${d1*a*b*c}"/> <!-- Body -->
<xacro:property name="m2" value="${d2*pi_const*r*r*d}"/> <!-- Wheels -->
<xacro:property name="m3" value="${d3*(4.0/3.0)*pi_const*r*r*r}"/> <!-- Caster -->

<!-- ================== MOMENTS OF INERTIA OF THE ROBOT BODY ================== -->
<xacro:property name="Ix_body"  value="${(1/12)*m1*(b*b+c*c) }" />
<xacro:property name="Iy_body"  value="${(1/12)*m1*(a*a+b*b) }" />
<xacro:property name="Iz_body"  value="${(1/12)*m1*(a*a+c*c) }" />

<!-- ================= MOMENTS OF INERTIA OF THE ROBOT WHEELS ================= -->
<xacro:property name="Iz_wheel" value="${0.5*m2*r*r}" />
<xacro:property name="I_wheel"  value="${(1.0/12.0)*m2*(3.0*r*r+d*d)}" />

<!-- ================ MOMENTS OF INERTIA OF THE CASTER SPHERE ================= -->
<xacro:property name="I_caster" value="${(2.0/5.0)*m3*r*r}" />

<!-- ==================== INERTIAL SECTION OF THE ROBOT BODY ================== -->
<xacro:macro name="inertia_body">
	<inertial>
	<!-- r = row, p = pitch, y = yaw -->
	<origin rpy="0 0 0" xyz="0 0 ${s1}"/>
	<mass value="${m1}"/>
	<inertia ixx="${Ix_body}" ixy="0.0" ixz="0.0" iyy="${Iy_body}" iyz="0" izz="${Iz_body}" />
	</inertial>
</xacro:macro>

<!-- ==================== INERTIAL SECTION OF THE WHEELS ====================== -->
<xacro:macro name="inertia_wheel">
	<inertial>
	<origin rpy="1.57079632 0 0" xyz="0 0 0"/> <!-- 90 degrees in radians -->
	<mass value="${m2}"/>
	<inertia ixx="${I_wheel}" ixy="0.0" ixz="0.0" iyy="${I_wheel}" iyz="0" izz="${Iz_wheel}" />
	</inertial>
</xacro:macro>

<!-- ==================== INERTIAL SECTION OF THE CASTER ====================== -->
<xacro:macro name="inertia_caster">
	<inertial>
	<origin rpy="0 0 0" xyz="0 0 0"/>
	<mass value="${m3}"/>
	<inertia ixx="${I_caster}" ixy="0.0" ixz="0.0" iyy="${I_caster}" iyz="0" izz="${I_caster}" />
	</inertial>
</xacro:macro>

<!-- ========================== ADDITIONAL PARAMETERS ========================= -->
<xacro:include filename="$(find multiagent_deep_rl_sim)/models/diff_drive/robot.gazebo"/>

<link name="base_footprint"> </link>
<joint name="body_link_joint" type="fixed">
	<parent link="base_footprint"/>
	<child link="body_link"/>
</joint>

<!-- =============================== BODY LINK ================================ -->
<link name="body_link">
	<visual>
		<geometry>
			<box size="${a} ${c} ${b}" />
		</geometry>
	<!-- Coordinate system attached to the body link joint -->
	<origin rpy="0 0 0" xyz="0 0 ${s1}"/>
	</visual>

	<!-- Specify how much space the robot consumes -->	
	<collision>
		<geometry>
			<box size="${a} ${c} ${b}" />
		</geometry>
		<origin rpy="0 0 0" xyz="0 0 ${s1}"/>
	</collision>

	<xacro:inertia_body />
</link>

<!-- ================ BACK RIGHT WHEEL OF THE ROBOT AND JOINT ================= -->
<joint name="wheel1_joint" type="continuous" >
	<parent link="body_link"/>
	<child  link="wheel1_link" />
	<origin xyz="${-s2} ${-s4} ${r}" rpy="0 0 0" /> <!-- Link frame body link -->
	<axis xyz="0 1 0"/>
	<limit effort="50000" velocity="10"/>
	<dynamics damping="1.0" friction="1.0"/>	
</joint>

<link name="wheel1_link">
	<visual>
		<origin rpy="1.57079632 0 0" xyz="0 0 0"/>
		<geometry>
			<cylinder length="${d}" radius="${r}"/>
		</geometry>
	</visual>

	<collision>
		<origin rpy="1.57079632 0 0" xyz="0 0 0"/>
		<geometry>
			<cylinder length="${d}" radius="${r}"/>
		</geometry>
	</collision>
	
	<xacro:inertia_wheel />
</link>

<!-- ================= BACK LEFT WHEEL OF THE ROBOT AND JOINT ================= -->
<joint name="wheel2_joint" type="continuous" >
	<parent link="body_link"/>
	<child  link="wheel2_link" />
	<origin xyz="${-s2} ${s4} ${r}" rpy="0 0 0" />
	<axis xyz="0 1 0"/>
	<limit effort="50000" velocity="10"/>
	<dynamics damping="1.0" friction="1.0"/>	
</joint>

<link name="wheel2_link">
	<visual>
		<origin rpy="1.57079632 0 0" xyz="0 0 0"/>
		<geometry>
			<cylinder length="${d}" radius="${r}"/>
		</geometry>
	</visual>

	<collision>
		<origin rpy="1.57079632 0 0" xyz="0 0 0"/>
		<geometry>
			<cylinder length="${d}" radius="${r}"/>
		</geometry>
	</collision>
	<xacro:inertia_wheel />
</link>

<!-- ============================= CASTER WHEEL =============================== -->
<joint name="caster_joint" type="fixed">
        <parent link="body_link"/>
        <child link="caster_link"/>
        <origin xyz="${s3} 0 ${r}" rpy="0 0 0"/>
</joint>
    

<link name="caster_link">
	<visual>
		<origin rpy="0 0 0" xyz="0 0 0"/>
		<geometry>
			<sphere radius="${r}" />
		</geometry>
	</visual>

	<collision>
		<origin rpy="0 0 0" xyz="0 0 0"/>
		<geometry>
			<sphere radius="${r}" />
		</geometry>
	</collision>
	<xacro:inertia_caster />
</link>

</robot>