<?xml version="1.0"?>
<sdf version="1.10">
  <model name="diff_drive">
    <static>false</static>

    <!-- Chassis on the wheels center z = wheel_r + chassis_h/2 -->
    <pose>0 0 0.14 0 0 0</pose>

    <!-- ================== CHASSIS =================== -->
    <!-- Base: L=0.35m x W=0.30m x H=0.12m, mass=0.3 kg -->
    <link name="chassis">
      <inertial>
        <mass>4.5</mass>
        <!-- Box inertia: Ixx=(1/12)m(y^2+z^2), etc. -->
        <inertia>
          <ixx>0.03915</ixx>
          <iyy>0.0513375</iyy>
          <izz>0.0796875</izz>
          <ixy>0</ixy><ixz>0</ixz><iyz>0</iyz>
        </inertia>
      </inertial>

      <collision name="chassis_col">
        <geometry><box><size>0.35 0.30 0.12</size></box></geometry>
        <surface>
            <friction><ode><mu>0.6</mu><mu2>0.6</mu2></ode></friction>
        </surface>
      </collision>

      <visual name="chassis_vis">
        <geometry><box><size>0.35 0.30 0.12</size></box></geometry>
        <material>
            <ambient>0.05 0.35 0.10 1</ambient>
            <diffuse>0.10 0.70 0.20 1</diffuse>
        </material>
      </visual>

      <!-- IMU mounted near the chassis -->
      <sensor name="imu" type="imu">
        <always_on>true</always_on>
        <update_rate>100</update_rate>
        <visualize>false</visualize>
        <topic>imu</topic>
      </sensor>
    </link>

    <!-- ================== LEFT WHEEL =================== -->
    <link name="left_wheel">
        <pose>0 0.15 0.08 0 0 0</pose>  <!-- y = +0.15, z = radius -->
        <inertial>
            <mass>0.3</mass>
            <!-- Solid cylinder (axis=Y): Iyy=0.5*m*r^2; Ixx=Izz=(1/12)*m*(3r^2+L^2) -->
            <inertia>
                <ixx>0.0005025</ixx>
                <iyy>0.00096</iyy>
                <izz>0.0005025</izz>
                <ixy>0</ixy><ixz>0</ixz><iyz>0</iyz>
            </inertia>
        </inertial>

        <collision name="wheel_col">
            <pose>0 0 0 1.57079632679 0 0</pose>
            <geometry><cylinder><radius>0.08</radius><length>0.03</length></cylinder></geometry>
            <surface><friction><ode><mu>1.2</mu><mu2>1.2</mu2></ode></friction></surface>
        </collision>
        <visual name="wheel_vis">
            <pose>0 0 0 1.57079632679 0 0</pose>
            <geometry><cylinder><radius>0.08</radius><length>0.03</length></cylinder></geometry>
            <material><ambient>0.2 0.2 0.2 1</ambient><diffuse>0.1 0.1 0.1 1</diffuse></material>
        </visual>
    </link>

    <!-- ================== RIGHT WHEEL =================== -->
    <link name="right_wheel">
        <pose>0 -0.15 0.08 0 0 0</pose>
        <inertial>
            <mass>0.3</mass>
            <inertia>
            <ixx>0.0005025</ixx>
            <iyy>0.00096</iyy>
            <izz>0.0005025</izz>
            <ixy>0</ixy><ixz>0</ixz><iyz>0</iyz>
            </inertia>
        </inertial>

        <collision name="wheel_col">
            <pose>0 0 0 1.57079632679 0 0</pose>
            <geometry><cylinder><radius>0.08</radius><length>0.03</length></cylinder></geometry>
            <surface><friction><ode><mu>1.2</mu><mu2>1.2</mu2></ode></friction></surface>
        </collision>
        <visual name="wheel_vis">
            <pose>0 0 0 1.57079632679 0 0</pose>
            <geometry><cylinder><radius>0.08</radius><length>0.03</length></cylinder></geometry>
            <material><ambient>0.2 0.2 0.2 1</ambient><diffuse>0.1 0.1 0.1 1</diffuse></material>
        </visual>
    </link>

    <!-- ================== CASTER =================== -->
    <link name="caster">
        <pose>-0.15 0 0.03 0 0 0</pose> <!-- rear & low -->
        <inertial>
            <mass>0.2</mass>
            <!-- Solid sphere: I = (2/5) m r^2 -->
            <inertia>
                <ixx>0.000072</ixx>
                <iyy>0.000072</iyy>
                <izz>0.000072</izz>
                <ixy>0</ixy><ixz>0</ixz><iyz>0</iyz>
            </inertia>
      </inertial>
      <collision name="caster_col">
        <geometry><sphere><radius>0.03</radius></sphere></geometry>
        <surface><friction><ode><mu>0.6</mu><mu2>0.6</mu2></ode></friction></surface>
      </collision>
      <visual name="caster_vis">
        <geometry><sphere><radius>0.03</radius></sphere></geometry>
        <material><ambient>0.2 0.2 0.2 1</ambient><diffuse>0.3 0.3 0.3 1</diffuse></material>
      </visual>
    </link>

    <!-- ================== PUSHER =================== -->
    <!-- Thickness 0.02m, width 0.28m, height 0.11m, mass 0.5kg -->
    <link name="pusher">
        <pose>0.185 0 0.06 0 0 0</pose>
        <inertial>
            <mass>0.5</mass>
            <inertia>
                <ixx>0.0037708333333333335</ixx>
                <iyy>0.0005208333333333332</iyy>
                <izz>0.0032833333333333334</izz>
                <ixy>0</ixy><ixz>0</ixz><iyz>0</iyz>
            </inertia>
        </inertial>
        <collision name="pusher_col">
            <geometry><box><size>0.02 0.28 0.11</size></box></geometry>
            <surface><friction><ode><mu>0.9</mu><mu2>0.9</mu2></ode></friction></surface>
        </collision>
        <visual name="pusher_vis">
            <geometry><box><size>0.02 0.28 0.11</size></box></geometry>
            <material><ambient>0.25 0.25 0.25 1</ambient><diffuse>0.8 0.8 0.8 1</diffuse></material>
        </visual>

        <!-- Contact sensor to know when we push -->
        <sensor name="pusher_contact" type="contact">
            <always_on>true</always_on>
            <update_rate>100</update_rate>
            <contact><collision>pusher_col</collision></contact>
            <visualize>false</visualize>
            <topic>/model/diff_drive/pusher_contact</topic>
        </sensor>
    </link>

    <!-- ================== JOINTS =================== -->
    <joint name="left_wheel_joint" type="revolute">
        <parent>chassis</parent>
        <child>left_wheel</child>
        <axis>
            <xyz>0 1 0</xyz>
            <limit><lower>-1e16</lower><upper>1e16</upper></limit>
            <dynamics><damping>0.05</damping></dynamics>
        </axis>
    </joint>

    <joint name="right_wheel_joint" type="revolute">
        <parent>chassis</parent>
        <child>right_wheel</child>
        <axis>
            <xyz>0 1 0</xyz>
            <limit><lower>-1e16</lower><upper>1e16</upper></limit>
            <dynamics><damping>0.05</damping></dynamics>
        </axis>
    </joint>

    <joint name="caster_joint" type="ball">
        <parent>chassis</parent>
        <child>caster</child>
    </joint>

    <joint name="pusher_fixed" type="fixed">
        <parent>chassis</parent>
        <child>pusher</child>
    </joint>

    <!-- Differential drive controller (cmd_vel -> wheel speeds; odometry out) -->
    <plugin filename="gz-sim-diff-drive-system" name="gz::sim::systems::DiffDrive">
      <left_joints>left_wheel_joint</left_joints>
      <right_joints>right_wheel_joint</right_joints>
      <wheel_separation>0.30</wheel_separation>
      <wheel_radius>0.08</wheel_radius>
      <odom_frame>odom</odom_frame>
      <topic>cmd_vel</topic>
      <odom_topic>odometry</odom_topic>
      <max_torque>6.0</max_torque>
    </plugin>

    <!-- Publish joint states (wheel encoders proxy) -->
    <plugin filename="gz-sim-joint-state-publisher-system"
        name="gz::sim::systems::JointStatePublisher">
    </plugin>

    <!-- Optional: wheel slip reporting (set low compliance for grippy wheels)
    <plugin filename="gz-sim-wheel-slip-system" name="gz::sim::systems::WheelSlip">
      <wheel link_name="left_wheel" collision_name="wheel_col">
        <wheel_radius>0.08</wheel_radius>
        <slip_compliance_lateral>0.0</slip_compliance_lateral>
        <slip_compliance_longitudinal>0.0</slip_compliance_longitudinal>
      </wheel>
      <wheel link_name="right_wheel" collision_name="wheel_col">
        <wheel_radius>0.08</wheel_radius>
        <slip_compliance_lateral>0.0</slip_compliance_lateral>
        <slip_compliance_longitudinal>0.0</slip_compliance_longitudinal>
      </wheel>
    </plugin> -->

    <plugin filename="gz-sim-pose-publisher-system" name="gz::sim::systems::PosePublisher">
      <publish_model_pose>true</publish_model_pose>
      <publish_link_pose>false</publish_link_pose>
      <update_frequency>30</update_frequency>
    </plugin>


  </model>
</sdf>